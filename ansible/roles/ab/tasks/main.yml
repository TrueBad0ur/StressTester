- name: Update apt and install apache2-utils
  become: true
  apt:
    update_cache: yes
    name: "{{ list_of_packages }}"
    state: latest

- name: Run stress tests
  shell: |
    for i in $(seq 100); do
      ab -n 100000 -c 16 -k -H "User-Agent: requests" {{ domain }} &
    done
  args:
    executable: /bin/bash
  async: 45
  poll: 0

- name: Stop all threads
  become: false
  shell:
    cmd: "sleep 10 && kill $(ps aux | grep 'ab -n' | grep -v grep | awk '{print $2}')"
